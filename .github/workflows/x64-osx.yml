---
name: 🍎 MacOS
on:
  push:
    branches:
      - vcpkg
      - release-**
  pull_request:
  release:
    types: ['published']


jobs:
  build:
    name: build (macos)
    runs-on: macos-12

    steps:
      - name: 🐣 Checkout
        uses: actions/checkout@v3

      - name: 🐩 Install CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: 🔨 Prepare build env
        run: |
          brew install automake bison flex gnu-sed create-dmg autoconf-archive
          echo $(brew --prefix bison)/bin >> $GITHUB_PATH
          echo $(brew --prefix flex)/bin >> $GITHUB_PATH

      - name: ⚒ Setup XCode
        uses: maxim-lobanov/setup-xcode@v1.5.1
        with:
          xcode-version: latest-stable

      - name: 🌱 Install dependencies and generate project files
        run: |
          cmake -S "${{ github.workspace }}" \
                -B "/Users/runner/build" \
                -G Ninja \
                -D CMAKE_BUILD_TYPE=Release \
                -D CMAKE_INSTALL_PREFIX:PATH=/Users/runner/build/vcpkg_installed/x64-osx-dynamic \
                -D WITH_VCPKG=ON \
                -D VCPKG_TARGET_TRIPLET=x64-osx-dynamic \
                -D VCPKG_HOST_TRIPLET=x64-osx-dynamic \
                -D WITH_QTWEBKIT=OFF \
                -D WITH_3D=OFF \
                -D WITH_BINDINGS=OFF \
                -D ENABLE_TESTS=OFF \
                -D VCPKG_MANIFEST_FEATURES="process;gui;desktop" \
                -D NUGET_USERNAME=m-kuhn \
                -D NUGET_TOKEN=${{ secrets.GITHUB_TOKEN }}

      - name: 🌋 Build
        run: |
          cmake --build "/Users/runner/build" --config Release

      - name: 📦 Package
        run: |
          cmake --install "/Users/runner/build" --config Release
          #          create-dmg --volname "QField Installer" --hide-extension qfield.app --volicon "${CMAKE_SOURCE_DIR}/platform/macos/installer.icns" --background "${CMAKE_SOURCE_DIR}/platform/macos/installer_background.png" --window-pos 200 120 --window-size 512 320 --icon-size 100 --icon "qfield.app" 130 160 --app-drop-link 400 155 --codesign "${MACOS_CODE_SIGN_IDENTITY}" ${CMAKE_BINARY_DIR}/QField-Installer.dmg  ${CMAKE_BINARY_DIR}/output/bin/qfield.app
          create-dmg --volname "QGIS Installer" --hide-extension qgis.app --window-pos 200 120 --window-size 512 320 --icon-size 100 --app-drop-link 400 155 ${CMAKE_BINARY_DIR}/QGIS-Installer.dmg  /Users/runner/build/vcpkg_installed/x64-osx-dynamic

      - name: 📦 Upload package
        uses: actions/upload-artifact@v3
        with:
          name: "QField-dev-x64-osx-experimental-qt6"
          path: ${{ env.CMAKE_BUILD_DIR }}/QField-Installer.dmg

      - name: tmate
        if: failure()
        uses: m-kuhn/action-tmate@patch-1
